FROM gradle:jdk21-ubi-minimal AS builder
WORKDIR /app
COPY gradlew build.gradle settings.gradle ./
COPY gradle ./gradle
COPY src ./src
RUN chmod +x ./gradlew
# ğŸ‘‡ build ëŒ€ì‹  bootJarë¥¼ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰ ê°€ëŠ¥í•œ JARë¥¼ ë§Œë“­ë‹ˆë‹¤.
RUN ./gradlew bootJar --no-daemon

# ğŸ‘‡ ë¹Œë“œëœ JAR íŒŒì¼ì˜ ë ˆì´ì–´ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
WORKDIR /app/extractor
RUN java -Djarmode=layertools -jar /app/build/libs/*.jar extract

# =========================================
# 2. ìµœì¢… ì‹¤í–‰ ìŠ¤í…Œì´ì§€ (Runner Stage) - í¬ê²Œ ë³€ê²½
# =========================================
FROM eclipse-temurin:21-jre
WORKDIR /app

# ë³´ì•ˆì„ ìœ„í•´ non-root ìœ ì € ìƒì„± ë° ì‚¬ìš©
RUN addgroup --system spring && adduser --system --ingroup spring spring
USER spring:spring

# ë¹Œë“œ ìŠ¤í…Œì´ì§€ì—ì„œ ì¶”ì¶œëœ ë ˆì´ì–´ë“¤ì„ ìˆœì„œëŒ€ë¡œ ë³µì‚¬
COPY --from=builder /app/extractor/dependencies/ ./
COPY --from=builder /app/extractor/spring-boot-loader/ ./
COPY --from=builder /app/extractor/snapshot-dependencies/ ./
COPY --from=builder /app/extractor/application/ ./

# ì• í”Œë¦¬ì¼€ì´ì…˜ í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8080

# ğŸ‘‡ ì‹¤í–‰ ë°©ì‹ì„ JarLauncherë¡œ ë³€ê²½
ENTRYPOINT ["java", "org.springframework.boot.loader.launch.JarLauncher"]