- name: Configure k0s Single Node Cluster
  hosts: all
  become: true # ëª¨ë“  ì‘ì—…ì„ sudo (ê´€ë¦¬ì) ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
  vars:
    # ì´ í”Œë ˆì´ë¶ì—ì„œ ì‚¬ìš©í•  ì‚¬ìš©ì ê³„ì • ì´ë¦„
    target_user: ubuntu
    k0s_version: "v1.33.2+k0s.0"

  tasks:
    # -----------------------------------------------------------------
    # 1. ê¸°ë³¸ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
    # -----------------------------------------------------------------
    - name: Update apt package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600 # 1ì‹œê°„ ë™ì•ˆ ìºì‹œ ìœ ì§€

    - name: Install prerequisite packages
      apt:
        name: ['curl', 'gnupg'] # Docker ì„¤ì¹˜ì— í•„ìš”í–ˆë˜ ì¼ë¶€ íŒ¨í‚¤ì§€ ì œì™¸
        state: present

    # -----------------------------------------------------------------
    # 4. Kubernetes ë„êµ¬ ì„¤ì¹˜ ë° ì„¤ì •
    # -----------------------------------------------------------------
    - name: Create kubectl alias using k0s
      copy:
        content: "alias kubectl='sudo k0s kubectl'"
        dest: /etc/profile.d/k0s-alias.sh
        mode: '0644'

    - name: Install Helm
      shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Install FluxCD CLI
      shell: curl -s https://fluxcd.io/install.sh | bash
      args:
        creates: /usr/local/bin/flux

    # -----------------------------------------------------------------
    # 5. k0s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ ë° ì‹¤í–‰
    # -----------------------------------------------------------------
    - name: Download specific k0s binary for ARM64
      get_url:
        url: "https://github.com/k0sproject/k0s/releases/download/{{ k0s_version }}/k0s-{{ k0s_version }}-arm64"
        dest: "/usr/local/bin/k0s"
        mode: '0755' # ë‹¤ìš´ë¡œë“œì™€ ë™ì‹œì— ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•©ë‹ˆë‹¤.
      # ğŸ‘‡ í•µì‹¬ ìˆ˜ì •: k0s íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ë•Œë§Œ ì´ ì‘ì—…ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.
      when: not k0s_binary_stat.stat.exists

    - name: Install k0s controller as a service
      command: k0s install controller --single # 'shell' ëŒ€ì‹  ë” ì•ˆì „í•œ 'command' ì‚¬ìš©
      args:
        creates: /etc/systemd/system/k0scontroller.service

    - name: Start and enable k0s service
      systemd:
        name: k0scontroller
        state: started
        enabled: yes

    # -----------------------------------------------------------------
    # 6. ìŠ¤í† ë¦¬ì§€ í”„ë¡œë¹„ì €ë„ˆë¥¼ ìœ„í•œ ë””ë ‰í† ë¦¬ ìƒì„±
    # -----------------------------------------------------------------
    - name: Create directory for OpenEBS storage
      file:
        path: /var/openebs/local
        state: directory
        mode: '0777' # ëª¨ë“  ì‚¬ìš©ìê°€ ì“¸ ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ì„¤ì •

    # -----------------------------------------------------------------
    # 7. (í•µì‹¬ ìˆ˜ì •) Kubeconfig íŒŒì¼ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
    # -----------------------------------------------------------------
    - name: Create .kube directory for the target user
      file:
        path: "/home/{{ target_user }}/.kube"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0755'

    - name: Generate k0s kubeconfig for the target user
      shell: "k0s kubeconfig admin > /home/{{ target_user }}/.kube/config"
      args:
        # ì´ íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ë‹¤ì‹œ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        creates: "/home/{{ target_user }}/.kube/config"

    - name: Set correct ownership for the kubeconfig file
      file:
        path: "/home/{{ target_user }}/.kube/config"
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
        mode: '0600' # ì†Œìœ ìë§Œ ì½ê³  ì“¸ ìˆ˜ ìˆë„ë¡ ë³´ì•ˆ ê°•í™”
